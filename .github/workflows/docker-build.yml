name: Build and Sign Docker Image

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  build-and-provenance:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: parsedmarc
      IMAGE_TAG: 8.18.1
      PARSEDMARC_VERSION: 8.18.1

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to DockerHub (or skip if using GHCR)
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: |
        docker build \
          --build-arg PARSEDMARC_VERSION=${{ env.PARSEDMARC_VERSION }} \
          -t $IMAGE_NAME:$IMAGE_TAG .

    - name: Get Docker image digest
      id: digest
      run: |
        docker push $IMAGE_NAME:$IMAGE_TAG > push_output.txt
        DIGEST=$(grep -o 'sha256:[a-f0-9]\{64\}' push_output.txt | head -n1)
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT

    - name: Generate SLSA provenance JSON
      run: |
        COMMIT=$(git rev-parse HEAD)
        cat <<EOF > provenance.json
        {
          "_type": "https://in-toto.io/Statement/v0.1",
          "subject": [
            {
              "name": "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}",
              "digest": {
                "sha256": "${{ steps.digest.outputs.digest#sha256: }}"
              }
            }
          ],
          "predicateType": "https://slsa.dev/provenance/v0.2",
          "predicate": {
            "builder": {
              "id": "https://github.com/${{ github.repository }}/.github/workflows/${{ github.workflow }}@${{ github.ref }}"
            },
            "buildType": "https://github.com/Attestations/GitHubActionsWorkflow",
            "invocation": {
              "configSource": {
                "uri": "git+https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "$COMMIT"
                },
                "entryPoint": "${{ github.workflow }}"
              },
              "parameters": {
                "dockerfile": "Dockerfile",
                "parsedmarc_version": "${{ env.PARSEDMARC_VERSION }}"
              },
              "environment": {
                "os": "${{ runner.os }}"
              }
            },
            "buildConfig": {
              "steps": [
                {
                  "command": [
                    "docker", "build", "-t", "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}", "."
                  ]
                },
                {
                  "command": [
                    "docker", "push", "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
                  ]
                }
              ]
            },
            "materials": [
              {
                "uri": "git+https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "$COMMIT"
                }
              }
            ]
          }
        }
        EOF

    - name: Upload provenance as artifact
      uses: actions/upload-artifact@v4
      with:
        name: slsa-provenance
        path: provenance.json
