name: Trivy Scan (Published Images)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "43 1 * * 3" # Wed 01:43 UTC
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  security-events: write

jobs:
  trivy:
    name: Trivy (latest + distroless + locked)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target:
          - name: latest
            repo: parsedmarc
            tag: latest
          - name: distroless
            repo: parsedmarc
            tag: distroless
          - name: locked-alpine
            repo: parsedmarc-locked
            tag: alpine
          - name: locked-debian
            repo: parsedmarc-locked
            tag: debian
          - name: locked-ubi
            repo: parsedmarc-locked
            tag: ubi

    steps:
      - name: Resolve image ref
        id: ref
        shell: bash
        run: |
          OWNER="${{ github.repository_owner }}"
          BASE="ghcr.io/${OWNER}/${{ matrix.target.repo }}"
          NAME="${{ matrix.target.name }}"

          if [ "${{ github.event_name }}" = "release" ]; then
            VER="${GITHUB_REF_NAME}"
            case "${NAME}" in
              latest)
                echo "IMAGE_REF=${BASE}:${VER}" >> "$GITHUB_OUTPUT"
                ;;
              distroless)
                echo "IMAGE_REF=${BASE}:${VER}-distroless" >> "$GITHUB_OUTPUT"
                ;;
              locked-alpine)
                echo "IMAGE_REF=${BASE}:${VER}-alpine" >> "$GITHUB_OUTPUT"
                ;;
              locked-debian)
                echo "IMAGE_REF=${BASE}:${VER}-debian" >> "$GITHUB_OUTPUT"
                ;;
              locked-ubi)
                echo "IMAGE_REF=${BASE}:${VER}-ubi" >> "$GITHUB_OUTPUT"
                ;;
              *)
                echo "Unsupported target"; exit 1
                ;;
            esac
          else
            echo "IMAGE_REF=${BASE}:${{ matrix.target.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check image exists in GHCR
        id: image_check
        shell: bash
        run: |
          if docker manifest inspect "${{ steps.ref.outputs.IMAGE_REF }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Image not available yet: ${{ steps.ref.outputs.IMAGE_REF }}"
          fi

      - name: Pull published image
        if: steps.image_check.outputs.exists == 'true'
        run: docker pull "${{ steps.ref.outputs.IMAGE_REF }}"

      - name: Trivy scan (SARIF)
        if: steps.image_check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.30.0
        with:
          image-ref: ${{ steps.ref.outputs.IMAGE_REF }}
          format: template
          template: '@/contrib/sarif.tpl'
          output: trivy-${{ matrix.target.name }}.sarif
          severity: CRITICAL,HIGH
          vuln-type: os,library
          ignore-unfixed: true

      - name: Upload SARIF to GitHub Security
        if: steps.image_check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-${{ matrix.target.name }}.sarif
          category: trivy-published-${{ matrix.target.name }}
