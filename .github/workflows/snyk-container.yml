name: Snyk Container Scan (Published Images)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "36 12 * * 4" # Thu 12:36 UTC
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  security-events: write

jobs:
  snyk:
    name: Snyk container (latest + distroless + locked)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target:
          - name: latest
            repo: parsedmarc
            tag: latest
          - name: distroless
            repo: parsedmarc
            tag: distroless
          - name: locked-alpine
            repo: parsedmarc-locked
            tag: alpine
          - name: locked-debian
            repo: parsedmarc-locked
            tag: debian
          - name: locked-ubi
            repo: parsedmarc-locked
            tag: ubi

    steps:
      - name: Resolve image ref
        id: ref
        shell: bash
        run: |
          OWNER="${{ github.repository_owner }}"
          BASE="ghcr.io/${OWNER}/${{ matrix.target.repo }}"
          NAME="${{ matrix.target.name }}"

          if [ "${{ github.event_name }}" = "release" ]; then
            VER="${GITHUB_REF_NAME}"
            case "${NAME}" in
              latest)
                echo "IMAGE_REF=${BASE}:${VER}" >> "$GITHUB_OUTPUT"
                ;;
              distroless)
                echo "IMAGE_REF=${BASE}:${VER}-distroless" >> "$GITHUB_OUTPUT"
                ;;
              locked-alpine)
                echo "IMAGE_REF=${BASE}:${VER}-alpine" >> "$GITHUB_OUTPUT"
                ;;
              locked-debian)
                echo "IMAGE_REF=${BASE}:${VER}-debian" >> "$GITHUB_OUTPUT"
                ;;
              locked-ubi)
                echo "IMAGE_REF=${BASE}:${VER}-ubi" >> "$GITHUB_OUTPUT"
                ;;
              *)
                echo "Unsupported target"; exit 1
                ;;
            esac
          else
            echo "IMAGE_REF=${BASE}:${{ matrix.target.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check image exists in GHCR
        id: image_check
        shell: bash
        run: |
          if docker manifest inspect "${{ steps.ref.outputs.IMAGE_REF }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Image not available yet: ${{ steps.ref.outputs.IMAGE_REF }}"
          fi

      - name: Pull published image
        if: steps.image_check.outputs.exists == 'true'
        run: docker pull "${{ steps.ref.outputs.IMAGE_REF }}"

      - name: Snyk scan (SARIF)
        if: steps.image_check.outputs.exists == 'true'
        uses: snyk/actions/docker@14818c4695ecc4045f33c9cee9e795a788711ca4
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ steps.ref.outputs.IMAGE_REF }}
          args: >
            --sarif-file-output=snyk-container-${{ matrix.target.name }}.sarif
            --severity-threshold=high

      - name: Check SARIF exists
        if: steps.image_check.outputs.exists == 'true'
        id: sarif_check
        shell: bash
        run: |
          [ -f "snyk-container-${{ matrix.target.name }}.sarif" ] \
            && echo "found=true" >> "$GITHUB_OUTPUT" \
            || echo "found=false" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF to GitHub Security
        if: steps.image_check.outputs.exists == 'true' && steps.sarif_check.outputs.found == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-container-${{ matrix.target.name }}.sarif
          category: snyk-container-published-${{ matrix.target.name }}
